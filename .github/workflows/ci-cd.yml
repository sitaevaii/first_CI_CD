name: CI/CD Pipeline with SAST

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

  steps:
    - name: Checkoute code
    uses: actions/checkout@v4

    - name: Set up Python
    uses: actions/setup-python@v5
    with:
      python-version: '3.10'

    - name: Install dependencies
    run: |
      python -m pip install --upgrade pip
      pip install -r requirements.txt
      pip install pytest

    - name: Run Bandit SAST Scan
    run: |
      pip install bandit
      bandit -r . --severity-level high --confidende-level high -f json -o bandit_results.json || true

    - name: Check Bandit Results
    id: bandit-check
    run: |
      if [-f bandit_results.json]; then
        if jq -e '.resultd[] | select(.issue_confidence == "HIGH" and .issue_severity == "HIGH")' bandit_results.json; then
          echo "Bandit found criticsl vulnerabilities! Falling the pipeline."
          exit 1
        else
          echo "No critical vulnerabilities found by Bandit."
      else
        echo "Bandit report not found. Assuming no issues."

    - name: Run Trivy vulnerability scanner
    uses: aquasecurity/trivy-action@master
    with:
      scan-type: 'fs'
      scan-ref: '.'
      format: 'table'
      exit-code: '1'
      ignore-unfixed: true
      severity: 'HIGH, CRITICAL'

    - name: Run Tests with pytest
    run: |
      python -m pytest tests/ -v
    
